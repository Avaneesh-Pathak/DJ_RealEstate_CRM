{% extends 'base.html' %}

{% block content %}
<style>
    /* Additional CSS for hover effect */
    .table tbody tr:hover {
        background-color: #02381c;
    }
    .table {
        border: 2px solid #061a30;
        border-radius: 10px;
        overflow: hidden;
    }
</style>
<div class="container mt-4">
    <h1 style="font-family: 'Poppins', sans-serif; font-size: xx-large; margin-bottom: 10px;" class="text-center">
        Analysis</h1>
    <div class="row">
        <!-- Total Leads -->
        <div class="col-md-4">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h3>Total Leads</h3>
                    <p class="display-4">{{ total_lead_count }}</p>
                </div>
            </div>
        </div>

        <!-- Leads in the Past 30 Days -->
        <div class="col-md-4">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h3>Leads in the Past 30 Days</h3>
                    <p class="display-4">{{ total_in_past30 }}</p>
                </div>
            </div>
        </div>

        <!-- Converted Leads in the Past 30 Days -->
        <div class="col-md-4">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <h3>Converted Leads in the Past 30 Days</h3>
                    <p class="display-4">{{ converted_in_past30 }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales and Profit Section -->
    <div class="row mt-4">
        <!-- Sales Data -->
        <div class="col-md-6">
            <h3 style="font-size:x-large;">Properties Sold Over Time</h3>
            <canvas id="salesChart"></canvas>
        </div>

        <!-- Profit Data -->
        <div class="col-md-6">
            <h3 style="font-size:x-large;">Profit Over Time</h3>
            <canvas id="profitChart"></canvas>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h3>Total Sales</h3>
                    <p class="display-4">₹{{ total_sales }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-danger text-white">
                <div class="card-body">
                    <h3>Total Cost</h3>
                    <p class="display-4">-₹{{ total_cost }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h3>Total Profit</h3>
                    <p class="display-4">₹{{ total_profit }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Section -->
    <div class="row mt-6">
        <div class="col-md-5">
            <h3 style="font-size: x-large;">Project Scheduler</h3>
            <div id="calendar" style="width: 600px; height: 300px; background-color: #f0f0f0;"></div>
        </div>

        <div class="col-md-6">
            <h3 style="font-size: x-large; text-align: center;">Top 5 Recent Buyers</h3>
            <table class="table table-striped table-bordered" style="width: 100%; height: auto; border-radius: 10px; overflow: hidden;">
                <thead style="background-color: #007bff; color: white;">
                    <tr>
                        <th style="width: 10%; text-align: center;">S.No</th>
                        <th style="width: 30%; text-align: center;">Buyer Name</th>
                        <th style="width: 20%; text-align: center;">Mobile No</th>
                        <th style="width: 15%; text-align: center;">Project</th>
                        <th style="width: 40%; text-align: center;">Booking Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for buyer in recent_buyers %}
                        <tr style="background-color: #f9f9f9; transition: background-color 0.3s;">
                            <td style="text-align: center;">{{ forloop.counter }}</td>
                            <td style="text-align: center;">{{ buyer.name }}</td>
                            <td style="text-align: center;">{{ buyer.mobile_no }}</td>
                            <td style="text-align: center;">{{ buyer.project.title }}</td>
                            <td style="text-align: center;">{{ buyer.booking_date }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" style="text-align: center; color: #777;">No buyers available.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>        
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- FullCalendar CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/main.min.js"></script>

<!-- Sales Chart -->
<script>
    const salesLabels = {{ labels| safe }};
    const salesData = {{ data| safe }};
    const salesCtx = document.getElementById('salesChart').getContext('2d');

    new Chart(salesCtx, {
        type: 'bar',
        data: {
            labels: salesLabels,
            datasets: [{
                label: 'Properties Sold',
                data: salesData,
                backgroundColor: 'rgba(30, 62, 98, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(30, 62, 98, 0.3)',
                pointBorderColor: '#fff',
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true, labels: { color: 'black' } },
                tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.7)', titleColor: 'white', bodyColor: 'white' }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
</script>

<!-- Profit Chart -->
<script>
    const profitLabels = {{ profit_labels| safe }};
    const profitData = {{ profit_data| safe }};
    const profitCtx = document.getElementById('profitChart').getContext('2d');

    new Chart(profitCtx, {
        type: 'line',
        data: {
            labels: profitLabels,
            datasets: [{
                label: 'Profit',
                data: profitData,
                backgroundColor: 'rgba(56, 116, 120, 0.8)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true, labels: { color: 'black' } },
                tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.7)', titleColor: 'white', bodyColor: 'white' }
            },
            scales: { y: { beginAtZero: true } }
        }
    });

    // Project Scheduler
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: [
                {
                    title: 'Meeting with Client A',
                    start: '2024-10-25T10:00:00',
                    end: '2024-10-25T12:00:00'
                },
                {
                    title: 'Property Sale Deadline',
                    start: '2024-10-28'
                }
                // Add more events here
            ]
        });

        calendar.render();
    });
</script>

{% endblock content %}